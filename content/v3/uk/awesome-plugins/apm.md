# FlightPHP APM Документація

Ласкаво просимо до FlightPHP APM—особистого тренера з продуктивності вашого додатку! Цей посібник є вашим дороговказом для налаштування, використання та освоєння Моніторингу Продуктивності Застосунків (APM) з FlightPHP. Незалежно від того, чи ви шукаєте повільні запити, чи просто хочете змоделювати графіки затримки, ми вас покриємо. Давайте зробимо ваш додаток швидшим, ваших користувачів щасливішими, а сеанси налагодження легшими!

## Чому важливий APM

Уявіть це: ваш додаток — це зайнятий ресторан. Без можливості відстежувати, як довго займають замовлення, або де кухня заважає, ви тільки гадатимете, чому клієнти йдуть незадоволеними. APM — це ваш су-шеф—він стежить за кожним кроком, від вхідних запитів до запитів до бази даних, та зазначає все, що уповільнює вас. Повільні сторінки втрачають користувачів (дослідження кажуть, що 53% йдуть, якщо сайт завантажується більше 3 секунд!), а APM допомагає вам виявити ці проблеми *до того, як* вони зашкодять. Це проактивний спокій—менше моментів «чому це не працює?», більше моментів «дивись, як це швидко працює!».

## Встановлення

Почніть з Composer:

```bash
composer require flightphp/apm
```

Вам потрібно:
- **PHP 7.4+**: Підтримуємо LTS дистрибутиви Linux, при цьому підтримуючи сучасний PHP.
- **[FlightPHP Core](https://github.com/flightphp/core) v3.15+**: Легкий фреймворк, який ми покращуємо.

## Початок роботи

Ось ваш покроковий план до APM прекрасності:

### 1. Зареєструйте APM

Додайте це у ваш `index.php` або файл `services.php`, щоб почати відстеження:

```php
use flight\apm\logger\LoggerFactory;
use flight\Apm;

$ApmLogger = LoggerFactory::create(__DIR__ . '/../../.runway-config.json');
$Apm = new Apm($ApmLogger);
$Apm->bindEventsToFlightInstance($app);
```

**Що тут відбувається?**
- `LoggerFactory::create()` отримує вашу конфігурацію (більше про це скоро) і налаштовує журнал—за замовчуванням SQLite.
- `Apm` — це зірка—він слухає події Flight (запити, маршрути, помилки тощо) і збирає метрики.
- `bindEventsToFlightInstance($app)` пов'язує все це з вашим додатком Flight.

**Порада: Зразок**
Якщо ваш додаток зайнятий, ведення журналістики *кожного* запиту може перевантажити систему. Використовуйте коефіцієнт вибірки (від 0.0 до 1.0):

```php
$Apm = new Apm($ApmLogger, 0.1); // Журналює 10% запитів
```

Це дозволяє зберігати швидкість продуктивності, даючи вам при цьому надійні дані.

### 2. Налаштуйте його

Запустіть це, щоб створити ваш `.runway-config.json`:

```bash
php vendor/bin/runway apm:init
```

**Що це робить?**
- Запускає майстра, який запитує, звідки беруться сирі метрики (джерело) і куди йдуть оброблені дані (призначення).
- За замовчуванням—SQLite, наприклад, `sqlite:/tmp/apm_metrics.sqlite` для джерела, інше для призначення.
- Ви отримаєте конфігурацію, як ця:
  ```json
  {
    "apm": {
      "source_type": "sqlite",
      "source_db_dsn": "sqlite:/tmp/apm_metrics.sqlite",
      "storage_type": "sqlite",
      "dest_db_dsn": "sqlite:/tmp/apm_metrics_processed.sqlite"
    }
  }
  ```

**Чому два місця?**
Сирі метрики накопичуються швидко (уявіть нефільтровані журнали). Робочий процес обробляє їх у структуроване призначення для інформаційної панелі. Зберігає порядок!

### 3. Обробіть метрики за допомогою робітника

Робітник перетворює сирі метрики на дані, готові до інформаційної панелі. Запустіть його один раз:

```bash
php vendor/bin/runway apm:worker
```

**Що він робить?**
- Читає з вашого джерела (наприклад, `apm_metrics.sqlite`).
- Обробляє до 100 метрик (рекомендований обсяг партії) до вашого призначення.
- Зупиняється, коли закінчує або якщо не залишилося метрик.

**Тримайте його запущеним**
Для живих додатків вам знадобиться безперервна обробка. Ось варіанти:

- **Режим демона**:
  ```bash
  php vendor/bin/runway apm:worker --daemon
  ```
  Запускається вічно, обробляючи метрики, як вони надходять. Чудово для розробки або малих налаштувань.

- **Crontab**:
  Додайте це у ваш crontab (`crontab -e`):
  ```bash
  * * * * * php /path/to/project/vendor/bin/runway apm:worker
  ```
  Запускається кожну хвилину—ідеально для виробництва.

- **Tmux/Screen**:
  Запустіть від'єднувану сесію:
  ```bash
  tmux new -s apm-worker
  php vendor/bin/runway apm:worker --daemon
  # Ctrl+B, потім D, щоб від'єднатися; `tmux attach -t apm-worker`, щоб підключитися
  ```
  Зберігає його запущеним, навіть якщо ви виходите.

- **Налаштування**:
  ```bash
  php vendor/bin/runway apm:worker --batch_size 50 --max_messages 1000 --timeout 300
  ```
  - `--batch_size 50`: Обробляє 50 метрик за раз.
  - `--max_messages 1000`: Зупиняється після 1000 метрик.
  - `--timeout 300`: Виходить після 5 хвилин.

**Навіщо піклуватися?**
Без робітника ваша інформаційна панель порожня. Це міст між сирими журналами та дієвими інсайтами.

### 4. Запустіть інформаційну панель

Подивіться на показники вашого додатку:

```bash
php vendor/bin/runway apm:dashboard
```

**Що це?**
- Запускає PHP-сервер на `http://localhost:8001/apm/dashboard`.
- Показує журнали запитів, повільні маршрути, рівні помилок та інше.

**Налаштуйте це**:
```bash
php vendor/bin/runway apm:dashboard --host 0.0.0.0 --port 8080 --php-path=/usr/local/bin/php
```
- `--host 0.0.0.0`: Доступний з будь-якої IP-адреси (зручно для віддаленого перегляду).
- `--port 8080`: Використовуйте інший порт, якщо 8001 зайнято.
- `--php-path`: Вкажіть шлях до PHP, якщо він не в вашій PATH.

Натисніть на URL у вашому браузері та досліджуйте!

#### Режим виробництва

Для виробництва вам може знадобитися спробувати кілька технік, щоб запустити інформаційну панель, оскільки, ймовірно, є брандмауери та інші заходи безпеки. Ось кілька варіантів:

- **Використовуйте зворотний проксі**: Налаштуйте Nginx або Apache для перенаправлення запитів до інформаційної панелі.
- **SSH тунель**: Якщо ви можете підключитися до сервера через SSH, використовуйте `ssh -L 8080:localhost:8001 youruser@yourserver`, щоб тунелювати інформаційну панель на ваш локальний комп'ютер.
- **VPN**: Якщо ваш сервер знаходиться за VPN, підключіться до нього та отримуйте доступ до панелі безпосередньо.
- **Налаштуйте брандмауер**: Відкрийте порт 8001 для вашої IP-адреси або мережі сервера. (або на якому б ви його налаштували).
- **Налаштуйте Apache/Nginx**: Якщо у вас є веб-сервер перед вашим додатком, ви можете налаштувати його на домен або піддомен. Якщо ви це зробите, ви встановите корінь документа на `/path/to/your/project/vendor/flightphp/apm/dashboard`

#### Хочете іншу інформаційну панель?

Ви можете побудувати свою власну інформаційну панель, якщо хочете! Подивіться на каталог vendor/flightphp/apm/src/apm/presenter, щоб отримати ідеї про те, як представляти дані для вашої власної інформаційної панелі!

## Особливості інформаційної панелі

Інформаційна панель є вашим APM головним офісом—ось що ви побачите:

- **Журнал запитів**: Кожен запит з міткою часу, URL, кодом відповіді та загальним часом. Натисніть «Деталі», щоб побачити посередників, запити та помилки.
- **Повільні запити**: Топ-5 запитів, що займають найбільше часу (наприклад, «/api/heavy» за 2.5с).
- **Повільні маршрути**: Топ-5 маршрутів за середнім часом—чудово для виявлення шаблонів.
- **Рівень помилок**: Відсоток запитів, що не виконуються (наприклад, 2.3% 500s).
- **Перцентилі затримки**: 95-й (p95) та 99-й (p99) часи відповіді—знайте свої найгірші сценарії.
- **Графік кодів відповіді**: Візуалізує 200s, 404s, 500s з часом.
- **Довгі запити/Посередники**: Топ-5 повільних запитів до бази даних та рівнів посередників.
- **Попадання/Пропуск кешу**: Як часто ваш кеш рятує ситуацію.

**Додатково**:
- Фільтруйте за «Остання година», «Останній день» або «Останній тиждень».
- Перемикайте темний режим для тих запізнілих сеансів.

**Приклад**:
Запит до `/users` може показати:
- Загальний час: 150мс
- Посередник: `AuthMiddleware->handle` (50мс)
- Запит: `SELECT * FROM users` (80мс)
- Кеш: Попадання на `user_list` (5мс)

## Додавання користувальницьких подій

Відстежуйте що завгодно—наприклад, виклик API чи процес оплати:

```php
use flight\apm\CustomEvent;

$app->eventDispatcher()->emit('apm.custom', new CustomEvent('api_call', [
    'endpoint' => 'https://api.example.com/users',
    'response_time' => 0.25,
    'status' => 200
]));
```

**Де це з'являється?**
У деталях запиту на інформаційній панелі під «Користувацькими подіями» — розширюване за допомогою красивого JSON-форматування.

**Використання**:
```php
$start = microtime(true);
$apiResponse = file_get_contents('https://api.example.com/data');
$app->eventDispatcher()->emit('apm.custom', new CustomEvent('external_api', [
    'url' => 'https://api.example.com/data',
    'time' => microtime(true) - $start,
    'success' => $apiResponse !== false
]));
```
Тепер ви зможете бачити, чи не тягне цей API ваш додаток вниз!

## Моніторинг бази даних

Відстежуйте запити PDO ось так:

```php
use flight\database\PdoWrapper;

$pdo = new PdoWrapper('sqlite:/path/to/db.sqlite');
$Apm->addPdoConnection($pdo);
```

**Що ви отримуєте**:
- Текст запиту (наприклад, `SELECT * FROM users WHERE id = ?`)
- Час виконання (наприклад, 0.015с)
- Кількість рядків (наприклад, 42)

**Зверніть увагу**:
- **Необов’язково**: Пропустіть це, якщо вам не потрібно відстеження БД.
- **Тільки PdoWrapper**: Основний PDO ще не підключено—чекайте на це!
- **Попередження про продуктивність**: Ведення журналу кожного запиту на БД-насиченому сайті може сповільнити його. Використовуйте зразки (`$Apm = new Apm($ApmLogger, 0.1)`), щоб зменшити навантаження.

**Приклад виходу**:
- Запит: `SELECT name FROM products WHERE price > 100`
- Час: 0.023с
- Рядків: 15

## Опції Робітника

Налаштуйте робітника на свій смак:

- `--timeout 300`: Зупиняється через 5 хвилин—добре для тестування.
- `--max_messages 500`: Обмеження до 500 метрик—зберігає це в межах.
- `--batch_size 200`: Обробляє 200 за раз—балансує швидкість і пам’ять.
- `--daemon`: Працює без зупинки—ідеально для живого моніторингу.

**Приклад**:
```bash
php vendor/bin/runway apm:worker --daemon --batch_size 100 --timeout 3600
```
Працює годину, обробляючи 100 метрик за раз.

## Випадок проблем

Ви застрягли? Спробуйте ці:

- **Немає даних на інформаційній панелі?**
  - Чи працює робітник? Перевірте `ps aux | grep apm:worker`.
  - Чи збігаються шляхи конфігурації? Переконайтеся, що DSN `.runway-config.json` вказує на реальні файли.
  - Запустіть `php vendor/bin/runway apm:worker` вручну, щоб обробити очікуючи метрики.

- **Помилки робітника?**
  - Погляньте на свої файли SQLite (наприклад, `sqlite3 /tmp/apm_metrics.sqlite "SELECT * FROM apm_metrics_log LIMIT 5"`).
  - Перевірте журнали PHP на стекові трасування.

- **Інформаційна панель не запускається?**
  - Порт 8001 зайнято? Використовуйте `--port 8080`.
  - PHP не знайдено? Використовуйте `--php-path /usr/bin/php`.
  - Брандмауер блокує? Відкрийте порт або використовуйте `--host localhost`.

- **Занадто повільно?**
  - Знизьте коефіцієнт вибірки: `$Apm = new Apm($ApmLogger, 0.05)` (5%).
  - Зменшіть обсяг партії: `--batch_size 20`.