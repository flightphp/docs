# Документация FlightPHP APM

Добро пожаловать в FlightPHP APM — ваш личный тренер по производительности приложения! Этот гайд — ваша дорожная карта по настройке, использованию и освоению мониторинга производительности приложений (APM) с FlightPHP. Независимо от того, ищете ли вы медленные запросы или просто хотите поразмышлять над графиками задержки, мы готовы помочь. Давайте сделаем ваше приложение быстрее, ваших пользователей счастливее, а ваши сессии отладки более легкими!

## Почему важен APM

Представьте это: ваше приложение — это загруженный ресторан. Без способа отследить, сколько времени занимает выполнение заказов, или где кухня буксует, вы гадали, почему клиенты уходят недовольными. APM — это ваш помощник — он следит за каждым шагом, от входящих запросов до запросов к базе данных, и сигнализирует о чем угодно, что замедляет вас. Медленные страницы теряют пользователей (исследования показывают, что 53% уходят, если сайт загружается более 3 секунд!), и APM помогает вам обнаружить эти проблемы *до* того, как они начнут беспокоить. Это проактивное спокойствие — меньше моментов “почему это сломано?”, больше “посмотрите, как быстро это работает!” побед.

## Установка

Начните с Composer:

```bash
composer require flightphp/apm
```

Вам понадобится:
- **PHP 7.4+**: Обеспечивает совместимость с LTS дистрибутивами Linux, поддерживая современный PHP.
- **[FlightPHP Core](https://github.com/flightphp/core) v3.15+**: Легковесный фреймворк, который мы усиливаем.

## Начало работы

Вот шаг за шагом к великолепию APM:

### 1. Зарегистрируйте APM

Вставьте это в ваш `index.php` или файл `services.php`, чтобы начать отслеживание:

```php
use flight\apm\logger\LoggerFactory;
use flight\Apm;

$ApmLogger = LoggerFactory::create(__DIR__ . '/../../.runway-config.json');
$Apm = new Apm($ApmLogger);
$Apm->bindEventsToFlightInstance($app);
```

**Что здесь происходит?**
- `LoggerFactory::create()` берет вашу конфигурацию (больше об этом скоро) и настраивает логгер — по умолчанию SQLite.
- `Apm` — это звезда — он слушает события Flight (запросы, маршруты, ошибки и т. д.) и собирает метрики.
- `bindEventsToFlightInstance($app)` связывает всё это с вашим приложением Flight.

**Совет профессионала: выборка**
Если ваше приложение загружено, ведение учета *каждого* запроса может перегружать систему. Используйте коэффициент выборки (от 0.0 до 1.0):

```php
$Apm = new Apm($ApmLogger, 0.1); // Логирует 10% запросов
```

Это позволяет поддерживать производительность на высоком уровне, предоставляя при этом надежные данные.

### 2. Настройка

Запустите это, чтобы создать ваш файл `.runway-config.json`:

```bash
php vendor/bin/runway apm:init
```

**Что это делает?**
- Запускает мастера, который спрашивает, откуда поступают сырые метрики (источник) и куда идут обработанные данные (назначение).
- По умолчанию используется SQLite — например, `sqlite:/tmp/apm_metrics.sqlite` для источника, другой для назначения.
- В конце у вас будет конфигурация вроде:
  ```json
  {
    "apm": {
      "source_type": "sqlite",
      "source_db_dsn": "sqlite:/tmp/apm_metrics.sqlite",
      "storage_type": "sqlite",
      "dest_db_dsn": "sqlite:/tmp/apm_metrics_processed.sqlite"
    }
  }
  ```

**Почему две локации?**
Сырые метрики накапливаются быстро (подумайте об нефильтрованных логах). Обработчик преобразует их в структурированное назначение для дашборда. Держит всё в порядке!

### 3. Обработка метрик с помощью рабочего процесса

Рабочий процесс преобразует сырые метрики в данные, готовые для дашборда. Запустите его один раз:

```bash
php vendor/bin/runway apm:worker
```

**Что он делает?**
- Читает из вашего источника (например, `apm_metrics.sqlite`).
- Обрабатывает до 100 метрик (размер партии по умолчанию) в ваше назначение.
- Останавливается, когда все сделано или если метрики отсутствуют.

**Держите его запущенным**
Для работающих приложений вы захотите непрерывную обработку. Вот ваши варианты:

- **Режим демона**:
  ```bash
  php vendor/bin/runway apm:worker --daemon
  ```
  Работает вечно, обрабатывая метрики по мере их поступления. Отлично подходит для разработки или небольших настроек.

- **Crontab**:
  Добавьте это в cron (`crontab -e`):
  ```bash
  * * * * * php /path/to/project/vendor/bin/runway apm:worker
  ```
  Срабатывает каждую минуту — идеально для продакшена.

- **Tmux/Screen**:
  Начните отсоединяемую сессию:
  ```bash
  tmux new -s apm-worker
  php vendor/bin/runway apm:worker --daemon
  # Ctrl+B, затем D, чтобы отсоединиться; `tmux attach -t apm-worker`, чтобы снова подключиться
  ```
  Держит его запущенным, даже если вы выйдете.

- **Пользовательские настройки**:
  ```bash
  php vendor/bin/runway apm:worker --batch_size 50 --max_messages 1000 --timeout 300
  ```
  - `--batch_size 50`: Обрабатывать 50 метрик за раз.
  - `--max_messages 1000`: Остановиться после 1000 метрик.
  - `--timeout 300`: Выйти через 5 минут.

**Почему это важно?**
Без рабочего процесса ваш дашборд пуст. Это мост между сырыми логами и действительными выводами доступной информации.

### 4. Запуск дашборда

Посмотрите на жизненные показатели вашего приложения:

```bash
php vendor/bin/runway apm:dashboard
```

**Что это?**
- Запускает сервер PHP на `http://localhost:8001/apm/dashboard`.
- Показывает журналы запросов, медленные маршруты, количество ошибок и многое другое.

**Настройка**:
```bash
php vendor/bin/runway apm:dashboard --host 0.0.0.0 --port 8080 --php-path=/usr/local/bin/php
```
- `--host 0.0.0.0`: Доступен с любого IP (удобно для удаленного просмотра).
- `--port 8080`: Используйте другой порт, если 8001 занят.
- `--php-path`: Укажите путь к PHP, если он не в вашем PATH.

Перейдите по URL в вашем браузере и исследуйте!

#### Режим продакшена

Для продакшена вам, возможно, придется попробовать несколько техник, чтобы запустить дашборд, так как, вероятно, имеются брандмауэры и другие меры безопасности. Вот несколько вариантов:

- **Используйте обратный прокси**: Настройте Nginx или Apache для пересылки запросов на дашборд.
- **SSH-туннель**: Если вы можете подключиться по SSH к серверу, используйте `ssh -L 8080:localhost:8001
youruser@yourserver`, чтобы туннелировать дашборд на вашу локальную машину.
- **VPN**: Если ваш сервер за VPN, подключитесь к нему и получите доступ к дашборду напрямую.
- **Настройка брандмауэра**: Откройте порт 8001 для вашего IP или сети сервера. (или любого другого порта, который вы установили).
- **Настройка Apache/Nginx**: Если у вас есть веб-сервер перед вашим приложением, вы можете настроить его на домен или поддомен. Если вы это сделаете, вы установите корневую папку документов на `/path/to/your/project/vendor/flightphp/apm/dashboard`

#### Хотите другой дашборд?

Вы можете создать свой собственный дашборд, если захотите! Посмотрите на каталог vendor/flightphp/apm/src/apm/presenter для идей о том, как представить данные для вашего собственного дашборда!

## Функции дашборда

Дашборд — это ваша APM база — вот что вы увидите:

- **Журнал запросов**: Каждый запрос с временной меткой, URL, кодом ответа и общим временем. Нажмите "Подробности", чтобы увидеть промежуточное ПО, запросы и ошибки.
- **Самые медленные запросы**: Топ-5 запросов, занимающих время (например, “/api/heavy” за 2.5с).
- **Самые медленные маршруты**: Топ-5 маршрутов по среднему времени — отлично для выявления паттернов.
- **Процент ошибок**: Процент запросов, которые завершаются ошибкой (например, 2.3% 500s).
- **Латентные перцентили**: 95-й (p95) и 99-й (p99) времена ответа — знайте свои наихудшие сценарии.
- **График кодов ответов**: Визуализируйте 200s, 404s, 500s с течением времени.
- **Долгие запросы/промежуточное ПО**: Топ-5 медленных запросов к базе данных и слоев промежуточного ПО.
- **Попадание/промах кеша**: Как часто ваш кеш выручает.

**Дополнительно**:
- Фильтры по «Последнему часу», «Последнему дню» или «Последней неделе».
- Переключатель темной темы для тех поздних сессий.

**Пример**:
Запрос к `/users` может показать:
- Общее время: 150ms
- Промежуточное ПО: `AuthMiddleware->handle` (50ms)
- Запрос: `SELECT * FROM users` (80ms)
- Кеш: Попадание на `user_list` (5ms)

## Добавление пользовательских событий

Отслеживайте всё — например, вызов API или процесс оплаты:

```php
use flight\apm\CustomEvent;

$app->eventDispatcher()->emit('apm.custom', new CustomEvent('api_call', [
    'endpoint' => 'https://api.example.com/users',
    'response_time' => 0.25,
    'status' => 200
]));
```

**Где это появится?**
В подробностях запроса на дашборде под "Пользовательскими событиями" — разворачивается с красивым JSON-форматом.

**Сценарий использования**:
```php
$start = microtime(true);
$apiResponse = file_get_contents('https://api.example.com/data');
$app->eventDispatcher()->emit('apm.custom', new CustomEvent('external_api', [
    'url' => 'https://api.example.com/data',
    'time' => microtime(true) - $start,
    'success' => $apiResponse !== false
]));
```
Теперь вы увидите, если этот API замедляет ваше приложение!

## Мониторинг базы данных

Отслеживайте запросы PDO таким образом:

```php
use flight\database\PdoWrapper;

$pdo = new PdoWrapper('sqlite:/path/to/db.sqlite');
$Apm->addPdoConnection($pdo);
```

**Что вы получаете**:
- Текст запроса (например, `SELECT * FROM users WHERE id = ?`)
- Время выполнения (например, 0.015s)
- Количество строк (например, 42)

**Обратите внимание**:
- **Необязательно**: Пропустите это, если вам не нужно отслеживание БД.
- **Только PdoWrapper**: Основной PDO пока не подключен — следите за обновлениями!
- **Предупреждение по производительности**: Ведение учета каждого запроса на сайте с высокой нагрузкой на БД может замедлить работу. Используйте выборку (`$Apm = new Apm($ApmLogger, 0.1)`), чтобы облегчить нагрузку.

**Пример вывода**:
- Запрос: `SELECT name FROM products WHERE price > 100`
- Время: 0.023s
- Строки: 15

## Опции рабочей среды

Настройте рабочий процесс по своему усмотрению:

- `--timeout 300`: Останавливается через 5 минут — хорошо для тестирования.
- `--max_messages 500`: Ограничивает до 500 метрик — держит это в пределах.
- `--batch_size 200`: Обрабатывает 200 за раз — балансирует скорость и память.
- `--daemon`: Работает без остановки — идеально для живого мониторинга.

**Пример**:
```bash
php vendor/bin/runway apm:worker --daemon --batch_size 100 --timeout 3600
```
Работает в течение часа, обрабатывая 100 метрик за раз.

## Устранение неполадок

Застряли? Попробуйте это:

- **Нет данных на дашборде?**
  - Работает ли рабочий процесс? Проверьте `ps aux | grep apm:worker`.
  - Совпадают ли пути конфигурации? Убедитесь, что DSN в `.runway-config.json` указывают на реальные файлы.
  - Запустите `php vendor/bin/runway apm:worker` вручную, чтобы обработать ожидающие метрики.

- **Ошибки рабочего процесса?**
  - Загляните в ваши SQLite файлы (например, `sqlite3 /tmp/apm_metrics.sqlite "SELECT * FROM apm_metrics_log LIMIT 5"`).
  - Проверьте журналы PHP на наличие трассировок стека.

- **Дашборд не запускается?**
  - Порт 8001 занят? Используйте `--port 8080`.
  - PHP не найден? Используйте `--php-path /usr/bin/php`.
  - Брандмауэр блокирует? Откройте порт или используйте `--host localhost`.

- **Слишком медленно?**
  - Уменьшите коэффициент выборки: `$Apm = new Apm($ApmLogger, 0.05)` (5%).
  - Уменьшите размер партии: `--batch_size 20`.